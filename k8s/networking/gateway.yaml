apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: application-gateway
  namespace: fyp
spec:
  selector:
    istio: unpaid-developers-singapore-istio-gateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: bchewy-zerossl-tls-secret
    hosts:
    - "*"
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "fyp.bchewy.com"
    - "argocd.bchewy.com"
    - "kibana.bchewy.com"
    - "grafana.bchewy.com"
    - "kiali.bchewy.com"
---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: application-virtualservice
  namespace: fyp
spec:
  # this specifies the hosts where the virtual service will be applied
  hosts:
  - "fyp.bchewy.com"
  - "argocd.bchewy.com"
  - "kibana.bchewy.com"
  - "grafana.bchewy.com"
  - "kiali.bchewy.com"
  gateways:
  - fyp/application-gateway
  http:
  # Domain-based routing for internal tools
  - name: argocd-route
    match:
    - authority:
        exact: argocd.bchewy.com
    route:
    - destination:
        host: argocd-server.argocd.svc.cluster.local
        port:
          number: 80
  - name: kibana-route
    match:
    - authority:
        exact: kibana.bchewy.com
    route:
    - destination:
        host: kibana-kb-http.logging.svc.cluster.local
        port:
          number: 5601
  - name: grafana-route
    match:
    - authority:
        exact: grafana.bchewy.com
    route:
    - destination:
        host: grafana.istio-system.svc.cluster.local
        port:
          number: 3000
  - name: kiali-route
    match:
    - authority:
        exact: kiali.bchewy.com
    route:
    - destination:
        host: kiali.istio-system.svc.cluster.local
        port:
          number: 20001

  # Path-based routing for main application
  - name: core-service-route # matched to core-service rollout
    match:
    - uri:
        prefix: "/core-service/"
    rewrite:
      uri: "/"
    route:
    - destination:
        host: core-service-stable.fyp.svc.cluster.local
        port:
          number: 8080
      weight: 100 # Initial weight
    - destination:
        host: core-service-canary.fyp.svc.cluster.local
        port:
          number: 8080
      weight: 0 # Initial weight

  - name: proxy-service-route # matched to proxy-service rollout
    match:
    - uri:
        prefix: "/proxy-service/"
    rewrite:
      uri: "/"
    route:
    - destination:
        host: proxy-service-stable.fyp.svc.cluster.local
        port:
          number: 8000
      weight: 100 # Initial weight
    - destination:
        host: proxy-service-canary.fyp.svc.cluster.local
        port:
          number: 8000
      weight: 0 # Initial weight

  - name: diagram-service-route # matched to diagram-service rollout
    match:
    - uri:
        prefix: "/diagram-service/"
    rewrite:
      uri: "/"
    route:
    - destination:
        host: diagram-service-stable.fyp.svc.cluster.local
        port:
          number: 8081
      weight: 100
    - destination:
        host: diagram-service-canary.fyp.svc.cluster.local
        port:
          number: 8081
      weight: 0

  - name: chatbot-service-route # matched to chatbot-service rollout
    match:
    - uri:
        prefix: "/chatbot-service/"
    rewrite:
      uri: "/"
    route:
    - destination:
        host: chatbot-service-stable.fyp.svc.cluster.local
        port:
          number: 8000
      weight: 100
    - destination:
        host: chatbot-service-canary.fyp.svc.cluster.local
        port:
          number: 8000
      weight: 0

  # Catch-all route for frontend - must be LAST since "/" matches all paths
  - name: frontend-route # matched to frontend rollout
    match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: frontend-stable.fyp.svc.cluster.local
        port:
          number: 80
      weight: 100 # Initial weight
    - destination:
        host: frontend-canary.fyp.svc.cluster.local
        port:
          number: 80
      weight: 0 # Initial weight
